<html>
<head>

<style type="text/css">
@import url(/css/main.css);
@import url(/css/overhead.css);
@import url(/css/themes/smoothness/jquery-ui-1.7.2.custom.css);
</style>
<script src="/js/jquery-1.3.2.js" type="text/javascript"></script>
<script src="/js/ui.core.js" type="text/javascript"></script>
<script src="/js/ui.draggable.js" type="text/javascript"></script>
<script src="/js/ui.droppable.js" type="text/javascript"></script>
<script src="/js/ui.resizable.js" type="text/javascript"></script>
<script src="/js/ui.dialog.js" type="text/javascript"></script>
<script type="text/javascript">
function zero_pad(s) {
    return s < 10 ? "0" + s : s;
}
// TODO Move some of this to external script (eg, add note function)?
$(document).ready(function() {

    $('#add-note').click(
        // Make an id for this note then add it to the DOM
        function() {
            var today = new Date();
            var h = zero_pad(today.getHours());
            var m = zero_pad(today.getMinutes());
            var s = zero_pad(today.getSeconds());
            var d = zero_pad(today.getDate());
            var mn = zero_pad(today.getMonth()+1);

            var noteId = '{{ user }}' + "-" + today.getTime();
            var note = $('<div class="Note" id="' + noteId + '"><textarea></textarea></div>');
            note.dialog(
                {
                    title: '{{ user }} at ' + h + ':' + m + ':' + s + ', ' + mn + '/' + d,
                    width: 240,
                    height: 198,
                    buttons: { 'Save' : function() {
                        // Make ajax call to save the note
                        var note = $(this);
                        var note_dialog = note.parent();
                        var offset = note_dialog.offset();
                        var oLeft = offset.left;
                        var oTop = offset.top;
                        var height = note_dialog.height();
                        var width = note_dialog.width();
                        var text = note.children('textarea').get(0).value;
                        var note_url = "/{{ user }}/overheads/{{ page }}/notes";
                        var note_key_container = note.children('span');
                        if (note_key_container.size() > 0) {
                            note_url += '/' + note_key_container.get(0).innerText;
                        }

                        // for testing
                        //note.children('textarea').get(0).value = text + '\n' + oLeft + ' ' + oTop + '\n' + height + ' ' + width;
                        $.post(
                            note_url,
                            { note_text : text, note_height : height, note_width : width, note_left : oLeft, note_top : oTop},
                            function(data, textStatus) {
                                if (textStatus == "success") {
                                    // TODO ??? Use something safer that only converts JSON see http://www.json.org/js.html.
                                    data = eval('(' + data + ')');

                                    if (note_url.match('notes/?$') != null) {
                                        var note_key = $('<span>' + data.key + '</span>');
                                        note_key.hide();
                                        note.append(note_key);
                                    }
                                    alert('Note saved');
                                } else {
                                    alert('Note not saved: ' + textStatus);
                                }
                            }
                        );
                    }},
                    position: [8, 100] // default left, top position for new note
                }
            );
        }
    );

    // Display existing notes
});
</script>
</head>
<body>

<div id="menu-bar">
{{ user }}
<form method="post" action="/{{ user }}/overheads/{{ page|urlencode }}">
<input id="add-note" type="button" value="Add Note"/>
<input id="manage-collaborators" type="button" value="Manage Collaborators"/>
tags <input type="text" size="30" name="tags" value="{{ tags }}" />
<input type="checkbox" value="public" name="access" {% ifequal access "public" %}checked="checked"{% endifequal %} /> public?
<input type="submit" value="Save"/>
</form>
Go to <a href="http://{{ page }}">{{ page }}</a>
</div>

<iframe width="100%" height="100%" src="http://{{ page }}"
border="0" noborder="noborder" frameborder="0" padding="0" spacing="0"></iframe>

</body>
</html>
