<html>
<head>

<style type="text/css">
@import url(/css/main.css);
@import url(/css/overhead.css);
@import url(/css/themes/smoothness/jquery-ui-1.7.2.custom.css);
</style>
<script src="/js/jquery-1.3.2.js" type="text/javascript"></script>
<script src="/js/ui.core.js" type="text/javascript"></script>
<script src="/js/ui.draggable.js" type="text/javascript"></script>
<script src="/js/ui.droppable.js" type="text/javascript"></script>
<script src="/js/ui.resizable.js" type="text/javascript"></script>
<script src="/js/ui.dialog.js" type="text/javascript"></script>
<script type="text/javascript">
var months = [
    'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'
];

function zero_pad(s) {
    return s < 10 ? "0" + s : s;
}

function displayable_update_time() {
    var today = new Date();
    var d = zero_pad(today.getDate());
    var h = today.getHours();
    var m = zero_pad(today.getMinutes());
    var tz = today.getTimezoneOffset() > 240 ? 'EST' : 'EDT';
    var ampm = h < 12 ? 'AM' : 'PM';
    return months[today.getMonth()] + " " + d + ", " + h % 12 + ":" + m + " " + ampm + ' ' + tz;
}

function display_note(note_data) {

    if (note_data.type != 'note') {
        // Default note when adding a new one
        note_data = {
            user: '{{ user }}',
            text: '',
            modified: displayable_update_time(),
            height: 140,
            width: 240,
            left:  8,
            top: 100,
            key: null
        };
    }
    var note = $('<div class="Note">').append($('<textarea></textarea>').append(note_data.text));
    if (note_data.key != null) {
        note.append($('<span>' + note_data.key + '</span>').hide());
    }
    note.dialog(
        {
            title: note_data.user + ' on ' + note_data.modified,
            width: note_data.width,
            height: note_data.height,
            buttons: { 'Save' : save_note },
            close: delete_note,
            position: [ note_data.left, note_data.top ]
        }
    );
}

// runs when note is closed. if previously saved it is deleted.
function delete_note(e) {
    alert(e.target);
    var note = $(e.target);
    var note_key_container = note.children('span');
    if (note_key_container.size() < 1) {
        return; // note hasn't been saved so just close it
    }
    var note_url = "/{{ user }}/overheads/{{ page }}/notes/" + note_key_container.get(0).innerText;
    $.post(
        note_url,
        { 'delete': 'true' },
        function(data, textStatus) {
            if (textStatus == "success") {
                alert('Note deleted');
            } else {
                alert('Note not saved: ' + textStatus);
            }
        }
    );
}

function save_note() {
    // Make ajax call to save the note
    var note = $(this);
    var note_dialog = note.parent();
    var offset = note_dialog.offset();
    var oLeft = offset.left;
    var oTop = offset.top;
    var height = note_dialog.height();
    var width = note_dialog.width();
    var text = note.children('textarea').get(0).value;
    var note_url = "/{{ user }}/overheads/{{ page }}/notes";
    var note_key_container = note.children('span');
    if (note_key_container.size() > 0) {
        note_url += '/' + note_key_container.get(0).innerText;
    }
    // for testing
    //note.children('textarea').get(0).value = text + '\n' + oLeft + ' ' + oTop + '\n' + height + ' ' + width;
    $.post(
        note_url,
        { note_text : text, note_height : height, note_width : width, note_left : oLeft, note_top : oTop},
        function(data, textStatus) {
            if (textStatus == "success") {
                // TODO ??? Use something safer that only converts JSON see http://www.json.org/js.html.
                data = eval('(' + data + ')');
                if (note_url.match('notes/?$') != null) {
                    note.append($('<span>' + data.key + '</span>').hide());
                }
                // Update notes title to include new update time
                var title = note.dialog('option', 'title').split(' on ');
                note.dialog('option', 'title', title[0] + ' on ' + displayable_update_time());
            } else {
                alert('Note not saved: ' + textStatus);
            }
        }
    );
}

// TODO ??? Move some of this to external script
$(document).ready(function() {

    // Add existing notes to the page. TODO ??? Move into another tmpl?
    {% for existing_bookmark_note in notes %}
    display_note({
        user: '{{ existing_bookmark_note.user }}',
        text: '{{ existing_bookmark_note.note }}',
        created: '{{ existing_bookmark_note.created }}',
        modified: '{{ existing_bookmark_note.local_modified|date:"M d, fA T" }}',
        width: {{ existing_bookmark_note.width }},
        height: {{ existing_bookmark_note.height }},
        top: {{ existing_bookmark_note.top }},
        left: {{ existing_bookmark_note.left }},
        key: '{{ existing_bookmark_note.key }}',
        type: 'note'
    });
    {% endfor %}

    $('#add-note').click(display_note);

    // Display existing notes
});
</script>
</head>
<body>

<div id="menu-bar">
{{ user }}
<form method="post" action="/{{ user }}/overheads/{{ page|urlencode }}">
<input id="add-note" type="button" value="Add Note"/>
<input id="manage-collaborators" type="button" value="Manage Collaborators"/>
tags <input type="text" size="30" name="tags" value="{{ tags }}" />
<input type="checkbox" value="public" name="access" {% ifequal access "public" %}checked="checked"{% endifequal %} /> public?
<input type="submit" value="Save"/>
</form>
Go to <a href="http://{{ page }}">{{ page }}</a>
</div>

<iframe width="100%" height="100%" src="http://{{ page }}"
border="0" noborder="noborder" frameborder="0" padding="0" spacing="0"></iframe>

</body>
</html>
